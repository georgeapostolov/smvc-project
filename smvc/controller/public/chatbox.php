<?	class controller_public_chatbox extends base_controller {		public function __construct() {			parent::__construct();			if ($this->user->is_logged == 0) {				header('Location: ' . ROOT_URL . 'login');				exit;			}		}		public function index() {			$this->view->set('user', $this->user);			$this->view->set('title', 'Chatbox');			$this->view->display('chatbox/index');		}		public function ajax() {			header('Content-Type: application/json');			$action = (isset($_POST['action']) && $_POST['action'] ? trim($_POST['action']) : '');			$result = array(				'success' => false,				'success_data' => false,				'error' => true,				'error_text' => 'Unknown action',			);			$chatbox = new model_public_chatbox();			switch ($action) {				case 'add_message':					try {						$message = array(							'message' => (isset($_POST['message']) && $_POST['message'] ? trim($_POST['message']) : ''),							'user_id' => $this->user->id,						);						$id = $chatbox->add_message($message);						if ($id) {							$result = array(								'success' => true,								'success_data' => $id,								'error' => false,								'error_text' => '',							);						}					} catch (Exception $e) {						$result['error_text'] = $e->getMessage();					}				break;				case 'get_chatbox':					try {						$messages = $chatbox->get_messages();						if ($messages) {							$result = array(								'success' => true,								'success_data' => $chatbox->get_messages_html($messages, $this->user->id),								'error' => false,								'error_text' => '',							);						}					} catch (Exception $e) {						$result['error_text'] = $e->getMessage();					}				break;			}			echo json_encode($result);		}	}