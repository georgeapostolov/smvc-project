<?	class model_public_chatbox extends base_model {		public function __construct() {			parent::__construct();		}		public function add_message($data = array()) {			$message = (isset($data['message']) && $data['message'] ? trim($data['message']) : '');			$user_id = (isset($data['user_id']) && $data['user_id'] ? (int)$data['user_id'] : 0);			if (true == empty($message)) {				throw new Exception('Message cannot be empty!', 1);			}			if ($user_id <= 0) {				throw new Exception('Only for registered users!', 2);			}			$query = '				INSERT INTO `chatbox` SET					`user_id` = ' . (int)$user_id . ',					`message` = "' . $this->db->escape($message) . '",					`insert_date` = UNIX_TIMESTAMP(),					`ip_address` = ' . (isset($_SERVER['REMOTE_ADDR']) ? ip2long($_SERVER['REMOTE_ADDR']) : 0) . '			';			$this->db->query($query);			return $this->db->insert_id();		}		public function get_messages() {			$query = '				SELECT					`t`.*,					`u`.`username`				FROM `chatbox` AS `t`				LEFT JOIN `users` AS `u` ON `u`.`id` = `t`.`user_id`				ORDER BY `t`.`id` DESC				LIMIT 50			';			$this->db->query($query);			$data = array();			while (false != ($result = $this->db->fetch())) {				$data[$result['id']] = $result;			}			ksort($data);			return $data;		}		public function get_messages_html($messages = array(), $current_user_id = 0) {			$html = '';			$time = time();			$today = strtotime('midnight today');			foreach ($messages as $message) {				$html .= '					<div class="chatbox_text_message ' . ($current_user_id == $message['user_id'] ? 'mine' : '') . '">						<div class="chatbox_text_message_time">' . (($message['insert_date'] < $today) ? date('d.m.Y, H:i:s', $message['insert_date']) : date('H:i:s', $message['insert_date'])) . '</div>						<div class="chatbox_text_message_name">' . $message['username'] . '</div>						<div class="chatbox_text_message_data">' . $this->make_links_clickable(nl2br(htmlspecialchars($message['message']))) . '</div>					</div>				';			}			return $html;		}		public function make_links_clickable($text) {			return preg_replace('!(((f|ht)tp(s)?://)[-a-zA-Zа-яА-Я()0-9@:%_+.~#?&;//=]+)!i', '<a href="$1" target="_blank">$1</a>', $text);		}	}